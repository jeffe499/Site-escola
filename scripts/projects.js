(function(){function qs(s){return document.querySelector(s)}function qsa(s){return Array.from(document.querySelectorAll(s))}function parseEmbedded(id,fallback){try{var el=document.getElementById(id);if(!el)return fallback;var txt=el.textContent.trim();return txt?JSON.parse(txt):fallback}catch(e){return fallback}}var items=parseEmbedded('embedded-projects',[]);fetch('data/projects.json',{cache:'no-store'}).then(function(r){if(!r.ok)throw 1;return r.json()}).then(function(d){items=d;render();}).catch(function(){render();});var perPage=4,currentPage=1,filtered=items.slice();var elList=qs('#projects-list'),elSearch=qs('#proj-search'),elCategory=qs('#proj-category'),elPagination=qs('#projects-pagination'),btnNew=qs('#proj-new');function render(){filtered=items.filter(function(it){var cat=elCategory?elCategory.value:'all';if(cat!=='all'&&it.category!==cat)return false;var q=elSearch?(elSearch.value||'').toLowerCase():'';if(q)return (it.title+' '+(it.summary||'')+' '+(it.details||'')).toLowerCase().indexOf(q)!==-1;return true});renderPage(currentPage);renderPagination()}function renderPage(page){currentPage=Math.max(1,Math.min(page,Math.ceil(filtered.length/perPage)||1));var start=(currentPage-1)*perPage;var pageItems=filtered.slice(start,start+perPage);if(pageItems.length===0){elList.innerHTML='<p class="muted">Nenhum projeto encontrado.</p>';return}elList.innerHTML=pageItems.map(function(p){return '<article class="news-item card"><h3>'+escapeHtml(p.title)+'</h3><small>Início: '+(p.start?new Date(p.start).toLocaleDateString('pt-BR'):'-')+' • Área: '+escapeHtml(p.category)+'</small><p>'+escapeHtml(p.summary)+'</p><p><button class="btn small view-project" data-id="'+p.id+'">Ver projeto</button></p></article>'}).join('');Array.from(document.querySelectorAll('.view-project')).forEach(function(b){b.addEventListener('click',function(){var id=Number(this.getAttribute('data-id'));var p=items.find(function(x){return x.id===id});if(!p)return;var html='<h3>'+escapeHtml(p.title)+'</h3><p><strong>Área:</strong> '+escapeHtml(p.category)+'</p><p><strong>Responsável:</strong> '+escapeHtml(p.lead||'-')+'</p><p>'+escapeHtml(p.details||p.summary)+'</p>';window.siteAPI.openModal(html)})})}function renderPagination(){var total=Math.ceil(filtered.length/perPage)||1;var html='';for(var i=1;i<=total;i++){html+='<button class="btn small page-btn'+(i===currentPage?' active':'')+'" data-page="'+i+'">'+i+'</button> '}elPagination.innerHTML=html;Array.from(document.querySelectorAll('.page-btn')).forEach(function(b){b.addEventListener('click',function(){renderPage(Number(this.getAttribute('data-page')));});})}elSearch.addEventListener('input',function(){currentPage=1;render()});elCategory.addEventListener('change',function(){currentPage=1;render()});btnNew.addEventListener('click',function(){var now=new Date().toISOString();var newid=Date.now();var demo={id:newid,title:'Projeto (demo) - '+new Date().toLocaleString(),category:'ciencia',summary:'Projeto criado localmente como demonstração.',start:now,lead:'Equipe',details:'Detalhes do projeto demo.'};items.unshift(demo);render();window.siteAPI.openModal('<h3>Projeto criado</h3><p>Projeto demo criado localmente. Ele não é persistente entre sessões.</p>')});function escapeHtml(s){if(!s)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}render();})();